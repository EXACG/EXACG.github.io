<!DOCTYPE html>
<head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>梦羽的AI绘图测试版前端</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/css/bootstrap.min.css">
        <style>
            #input {
				position: absolute;
				top: 0;
				left: 0;
				opacity: 0;
				z-index: -10;
			}
            .container{
                display:table;
                height:80%;
            }
            .row{
                display: table-cell;
                vertical-align: middle;
            }
            .row-centered {
                text-align:center;
            }
            .col-centered {
                display:inline-block;
                float:none;
                text-align:center;
            }
            .alert{
				font-size: 13px;
				display:block;
				margin:0 auto;
			}
            .upload-file{
                  position: relative;
                  width: 300px;
                  left:0;
                  right:0;
                  margin:0 auto;
                  padding: 10px 15px;
                  border-radius: 5px;
                  background-color: rgb(230,230,250);
                  color: #333333;
                  font-size: 14px;
                  text-align: center;
                  overflow: hidden;
                  
                }
            
            .upload-file span{
                  text-overflow: ellipsis;
                  white-space: nowrap;
                  overflow: hidden;
            }
            
            .upload-file:hover{
                  font-size: 55px;
                  border-color: rgb(39, 226, 81);
                }
            
            .upload-file input[type='file']{
                  height: 80%;
                  width: 80%;
                  position: absolute;
                  top: 0;
                  right: 0;
                  opacity: 0;
                  filter: alpha(opacity=0);
                  cursor: pointer;
                }
                img{
                 width:auto;
                 height:auto;
                 max-width:80%;
                 max-height:80%;
                }

        </style>
    </head>
<body>
    <h4 style="text-align:center;font-size:20px;">梦羽的AI绘图(测试版前端)</h4>
    <div class="container">
        <form role="form" action="#" onsubmit="return false" method="post" enctype="multipart/form-data" id="uploadForm">
        <div class="upload-file">
        <input type="text">
        <span class="tip">请输入想要的关键词</span>
        <button type="submit" name="submit" class="btn btn-primary btn-block" style="background:#4066ff;text-align:center;width:150px;height:30px;display:block;margin:0 auto" onclick="submitdata()">开始绘图</button>
        </div>
        <br><div class="Result">
            <hr/>
            <h3>(本项目测试版前端是随手撸出来的,可能不太美观233 但这个是一个单页实现的,可以自行修改!<br/><br/>GITHUB仓库地址:<a href="https://github.com/EXACG/nove_api_web">EXACG/nove_api_web</a></h3>
            <hr/>
            <h3>公开使用,限制每个月10万次请求额度! <br/>QQ:1031029814 QQ频道:<a href="https://qun.qq.com/qqweb/qunpro/share?_wv=3&_wwv=128&inviteCode=1cg5Q4&from=246610&biz=ka">精神养老院</a></h3>
        </div>
        </form><br>
        
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script type="text/javascript">
    function randomRange(min, max) { // min最小值，max最大值
        return Math.floor(Math.random() * (max - min)) + min;
    }
        function submitdata() {
            $(".container .Result").css('display', 'block');
			$(".container .Result").html(
						    '<div class="alert alert-warning"><strong>生成中，请稍候...</strong></div>');
			$(".container .ewm").css('display', 'block');
            
            // 使用新的API请求方法
            $.ajax({
                url: 'https://mmh.vwo50.workers.dev/gradio_api/call/infer',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    data: [
                        $("input").val(),
                        "lowres, {bad}, error, fewer, extra, missing, worst quality, jpeg artifacts, bad quality, watermark, unfinished, displeasing, chromatic aberration, signature, extra digits, artistic error, username, scan, [abstract]",
                        true,
                        0,
                        1024,
                        1536,
                        7,
                        28,
                        true
                    ]
                }),
                success: function(response) {
                    var eventId = response.event_id;
                    // 设置结果显示容器
                    $(".container .Result").html(
                        '<div class="alert alert-danger" style="text-align:center;margin:0 auto"><img id="generatedImage" src="" alt="生成中..." width="512" height="512"/></div>'
                    );
                    
                    // 通过SSE获取结果
                    var eventSource = new EventSource('https://mmh.vwo50.workers.dev/gradio_api/call/infer/' + eventId);
                    
                    // 接收数据的处理函数
                    eventSource.onmessage = function(event) {
                        console.log("收到SSE消息:", event.data);
                        
                        // 判断是否包含图片数据
                        if (event.data.includes("url") && event.data.includes("image.png")) {
                            try {
                                // 从数据中提取JSON部分（如果有data:前缀）
                                var jsonStr = event.data;
                                if (jsonStr.includes("data:")) {
                                    jsonStr = jsonStr.split("data:")[1].trim();
                                }
                                
                                var jsonData = JSON.parse(jsonStr);
                                
                                if (Array.isArray(jsonData) && jsonData.length > 0 && jsonData[0].url) {
                                    var imageUrl = jsonData[0].url;
                                    console.log("提取到图片URL:", imageUrl);
                                    
                                    // 显示生成的图片
                                    $(".container .Result").html(
                                        '<div class="alert alert-success" style="text-align:center;margin:0 auto"><img src="' + imageUrl + '" alt="生成的图像" width="512" height="auto"/></div>'
                                    );
                                    
                                    // 关闭连接
                                    eventSource.close();
                                    clearTimeout(timeout); // 清除超时
                                }
                            } catch (e) {
                                console.error("解析JSON数据出错:", e, "原始数据:", event.data);
                            }
                        }
                    };
                    
                    // 专门处理complete事件
                    eventSource.addEventListener('complete', function(event) {
                        console.log("收到complete事件:", event.data);
                        try {
                            // 从数据中提取JSON部分（如果有data:前缀）
                            var jsonStr = event.data;
                            if (jsonStr.includes("data:")) {
                                jsonStr = jsonStr.split("data:")[1].trim();
                            }
                            
                            var jsonData = JSON.parse(jsonStr);
                            
                            if (Array.isArray(jsonData) && jsonData.length > 0 && jsonData[0].url) {
                                var imageUrl = jsonData[0].url;
                                console.log("complete事件提取到图片URL:", imageUrl);
                                
                                // 显示生成的图片
                                $(".container .Result").html(
                                    '<div class="alert alert-success" style="text-align:center;margin:0 auto"><img src="' + imageUrl + '" alt="生成的图像" width="512" height="auto"/></div>'
                                );
                                
                                // 关闭连接
                                eventSource.close();
                                clearTimeout(timeout); // 清除超时
                            }
                        } catch (e) {
                            console.error("解析complete事件数据出错:", e, "原始数据:", event.data);
                        }
                    });
                    
                    // 处理错误
                    eventSource.onerror = function(error) {
                        console.error("SSE连接错误:", error);
                        eventSource.close();
                        clearTimeout(timeout); // 清除超时
                        $(".container .Result").html(
                            '<div class="alert alert-danger"><strong>连接出错，请重试</strong></div>'
                        );
                    };
                    
                    // 设置超时，防止长时间无响应
                    var timeout = setTimeout(function() {
                        if (eventSource.readyState !== EventSource.CLOSED) {
                            console.warn("SSE连接超时，自动关闭");
                            eventSource.close();
                            $(".container .Result").html(
                                '<div class="alert alert-warning"><strong>请求超时，请重试</strong></div>'
                            );
                        }
                    }, 60000); // 60秒超时
                },
                error: function() {
                    $(".container .Result").html(
                        '<div class="alert alert-danger"><strong>请求失败，请重试</strong></div>'
                    );
                }
            });
        }
    </script>
</body>
</html>
